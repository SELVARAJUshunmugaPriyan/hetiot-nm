#!/usr/bin/python
import sys
from mininet.node import Controller
from mn_wifi.node import OVSKernelAP
from mininet.log import setLogLevel, info
from mn_wifi.link import wmediumd, mesh
from mn_wifi.cli import CLI
from mn_wifi.net import Mininet_wifi
from mn_wifi.wmediumdConnector import interference


def topology():
	"Create a network."
	net = Mininet_wifi(link=wmediumd, wmediumd_mode=interference, controller=Controller)
	info("*** Creating nodes\n")
	"""
	sta11 = net.addStation('sta11', position='0,0,0')
	sta12 = net.addStation('sta12', position='50,0,0')
	sta13 = net.addStation('sta13', position='100,0,0')
	sta14 = net.addStation('sta14', position='150,0,0')
	sta15 = net.addStation('sta15', position='200,0,0')
	sta16 = net.addStation('sta16', position='250,0,0')
	sta17 = net.addStation('sta17', position='300,0,0')
	sta18 = net.addStation('sta18', position='350,0,0')
	sta19 = net.addStation('sta19', position='400,0,0')
	sta10 = net.addStation('sta10', position='450,0,0')
	sta21 = net.addStation('sta21', position='0,50,0')
	sta22 = net.addStation('sta22', position='50,50,0')
	sta23 = net.addStation('sta23', position='100,50,0')
	sta24 = net.addStation('sta24', position='150,50,0')
	sta25 = net.addStation('sta25', position='200,50,0')
	sta26 = net.addStation('sta26', position='250,50,0')
	sta27 = net.addStation('sta27', position='300,50,0')
	sta28 = net.addStation('sta28', position='350,50,0')
	sta29 = net.addStation('sta29', position='400,50,0')
	sta20 = net.addStation('sta20', position='450,50,0')
	sta31 = net.addStation('sta31', position='0,100,0')
	sta32 = net.addStation('sta32', position='50,100,0')
	sta33 = net.addStation('sta33', position='100,100,0')
	sta34 = net.addStation('sta34', position='150,100,0')
	sta35 = net.addStation('sta35', position='200,100,0')
	sta36 = net.addStation('sta36', position='250,100,0')
	sta37 = net.addStation('sta37', position='300,100,0')
	sta38 = net.addStation('sta38', position='350,100,0')
	sta39 = net.addStation('sta39', position='400,100,0')
	sta30 = net.addStation('sta30', position='450,100,0')
	sta41 = net.addStation('sta41', position='0,150,0')
	sta42 = net.addStation('sta42', position='50,150,0')
	sta43 = net.addStation('sta43', position='100,150,0')
	sta44 = net.addStation('sta44', position='150,150,0')
	sta45 = net.addStation('sta45', position='200,150,0')
	sta46 = net.addStation('sta46', position='250,150,0')
	sta47 = net.addStation('sta47', position='300,150,0')
	sta48 = net.addStation('sta48', position='350,150,0')
	sta49 = net.addStation('sta49', position='400,150,0')
	sta40 = net.addStation('sta40', position='450,150,0')
	sta51 = net.addStation('sta51', position='0,200,0')
	sta52 = net.addStation('sta52', position='50,200,0')
	sta53 = net.addStation('sta53', position='100,200,0')
	sta54 = net.addStation('sta54', position='150,200,0')
	"""
	sta55 = net.addStation('sta55', position='200,200,0')
	sta56 = net.addStation('sta56', position='250,200,0')
	sta57 = net.addStation('sta57', position='300,200,0')
	sta58 = net.addStation('sta58', position='350,200,0')
	sta59 = net.addStation('sta59', position='400,200,0')
	sta50 = net.addStation('sta50', position='450,200,0')
	#sta61 = net.addStation('sta61', position='0,250,0')
	#sta62 = net.addStation('sta62', position='50,250,0')
	#sta63 = net.addStation('sta63', position='100,250,0')
	#sta64 = net.addStation('sta64', position='150,250,0')
	sta65 = net.addStation('sta65', position='200,250,0')
	sta66 = net.addStation('sta66', position='250,250,0')
	sta67 = net.addStation('sta67', position='300,250,0')
	sta68 = net.addStation('sta68', position='350,250,0')
	sta69 = net.addStation('sta69', position='400,250,0')
	sta60 = net.addStation('sta60', position='450,250,0')
	#sta71 = net.addStation('sta71', position='0,300,0')
	#sta72 = net.addStation('sta72', position='50,300,0')
	#sta73 = net.addStation('sta73', position='100,300,0')
	#sta74 = net.addStation('sta74', position='150,300,0')
	sta75 = net.addStation('sta75', position='200,300,0')
	sta76 = net.addStation('sta76', position='250,300,0')	
	sta77 = net.addStation('sta77', position='300,300,0')
	sta78 = net.addStation('sta78', position='350,300,0')
	sta79 = net.addStation('sta79', position='400,300,0')
	sta70 = net.addStation('sta70', position='450,300,0')
	#sta81 = net.addStation('sta81', position='0,350,0')
	#sta82 = net.addStation('sta82', position='50,350,0')
	#sta83 = net.addStation('sta83', position='100,350,0')
	#sta84 = net.addStation('sta84', position='150,350,0')
	sta85 = net.addStation('sta85', position='200,350,0')
	sta86 = net.addStation('sta86', position='250,350,0')
	sta87 = net.addStation('sta87', position='300,350,0')
	sta88 = net.addStation('sta88', position='350,350,0')
	sta89 = net.addStation('sta89', position='400,350,0')
	sta80 = net.addStation('sta80', position='450,350,0')
	#sta91 = net.addStation('sta91', position='0,400,0')
	#sta92 = net.addStation('sta92', position='50,400,0')
	#sta93 = net.addStation('sta93', position='100,400,0')
	#sta94 = net.addStation('sta94', position='150,400,0')
	sta95 = net.addStation('sta95', position='200,400,0')
	sta96 = net.addStation('sta96', position='250,400,0')
	sta97 = net.addStation('sta97', position='300,400,0')
	sta98 = net.addStation('sta98', position='350,400,0')
	sta99 = net.addStation('sta99', position='400,400,0')
	sta90 = net.addStation('sta90', position='450,400,0')
	#sta101 = net.addStation('sta101', position='0,450,0')
	#sta102 = net.addStation('sta102', position='50,450,0')
	#sta103 = net.addStation('sta103', position='100,450,0')
	#sta104 = net.addStation('sta104', position='150,450,0')
	sta105 = net.addStation('sta105', position='200,450,0')
	sta106 = net.addStation('sta106', position='250,450,0')
	sta107 = net.addStation('sta107', position='300,450,0')
	sta108 = net.addStation('sta108', position='350,450,0')
	sta109 = net.addStation('sta109', position='400,450,0')
	sta100 = net.addStation('sta100', position='450,450,0')

		
	ap1 = net.addAccessPoint('ap1', ssid='new-ssid', mode='g', wlans=2,
												 channel='1', position='500,500,0')
	c1 = net.addController('c1', controller=Controller)

	info("*** Configuring Propagation Model\n")
	net.setPropagationModel(model="logDistance", exp=4)

	info("*** Configuring wifi nodes\n")
	net.configureWifiNodes()

	info("*** Creating links\n")

	"""
	net.addLink(sta11, cls=mesh, ssid='meshNet', intf='sta11-wlan0', channel=5)
	net.addLink(sta12, cls=mesh, ssid='meshNet', intf='sta12-wlan0', channel=5)
	net.addLink(sta13, cls=mesh, ssid='meshNet', intf='sta13-wlan0', channel=5)
	net.addLink(sta14, cls=mesh, ssid='meshNet', intf='sta14-wlan0', channel=5)
	net.addLink(sta15, cls=mesh, ssid='meshNet', intf='sta15-wlan0', channel=5)
	net.addLink(sta16, cls=mesh, ssid='meshNet', intf='sta16-wlan0', channel=5)
	net.addLink(sta17, cls=mesh, ssid='meshNet', intf='sta17-wlan0', channel=5)
	net.addLink(sta18, cls=mesh, ssid='meshNet', intf='sta18-wlan0', channel=5)
	net.addLink(sta19, cls=mesh, ssid='meshNet', intf='sta19-wlan0', channel=5)
	net.addLink(sta10, cls=mesh, ssid='meshNet', intf='sta10-wlan0', channel=5)
	net.addLink(sta21, cls=mesh, ssid='meshNet', intf='sta21-wlan0', channel=5)
	net.addLink(sta22, cls=mesh, ssid='meshNet', intf='sta22-wlan0', channel=5)
	net.addLink(sta23, cls=mesh, ssid='meshNet', intf='sta23-wlan0', channel=5)
	net.addLink(sta24, cls=mesh, ssid='meshNet', intf='sta24-wlan0', channel=5)
	net.addLink(sta25, cls=mesh, ssid='meshNet', intf='sta25-wlan0', channel=5)
	net.addLink(sta26, cls=mesh, ssid='meshNet', intf='sta26-wlan0', channel=5)
	net.addLink(sta27, cls=mesh, ssid='meshNet', intf='sta27-wlan0', channel=5)
	net.addLink(sta28, cls=mesh, ssid='meshNet', intf='sta28-wlan0', channel=5)
	net.addLink(sta29, cls=mesh, ssid='meshNet', intf='sta29-wlan0', channel=5)
	net.addLink(sta20, cls=mesh, ssid='meshNet', intf='sta20-wlan0', channel=5)
	net.addLink(sta31, cls=mesh, ssid='meshNet', intf='sta31-wlan0', channel=5)
	net.addLink(sta32, cls=mesh, ssid='meshNet', intf='sta32-wlan0', channel=5)
	net.addLink(sta33, cls=mesh, ssid='meshNet', intf='sta33-wlan0', channel=5)
	net.addLink(sta34, cls=mesh, ssid='meshNet', intf='sta34-wlan0', channel=5)
	net.addLink(sta35, cls=mesh, ssid='meshNet', intf='sta35-wlan0', channel=5)
	net.addLink(sta36, cls=mesh, ssid='meshNet', intf='sta36-wlan0', channel=5)
	net.addLink(sta37, cls=mesh, ssid='meshNet', intf='sta37-wlan0', channel=5)
	net.addLink(sta38, cls=mesh, ssid='meshNet', intf='sta38-wlan0', channel=5)
	net.addLink(sta39, cls=mesh, ssid='meshNet', intf='sta39-wlan0', channel=5)
	net.addLink(sta30, cls=mesh, ssid='meshNet', intf='sta30-wlan0', channel=5)
	net.addLink(sta41, cls=mesh, ssid='meshNet', intf='sta41-wlan0', channel=5)
	net.addLink(sta42, cls=mesh, ssid='meshNet', intf='sta42-wlan0', channel=5)
	net.addLink(sta43, cls=mesh, ssid='meshNet', intf='sta43-wlan0', channel=5)
	net.addLink(sta44, cls=mesh, ssid='meshNet', intf='sta44-wlan0', channel=5)
	net.addLink(sta45, cls=mesh, ssid='meshNet', intf='sta45-wlan0', channel=5)
	net.addLink(sta46, cls=mesh, ssid='meshNet', intf='sta46-wlan0', channel=5)
	net.addLink(sta47, cls=mesh, ssid='meshNet', intf='sta47-wlan0', channel=5)
	net.addLink(sta48, cls=mesh, ssid='meshNet', intf='sta48-wlan0', channel=5)
	net.addLink(sta49, cls=mesh, ssid='meshNet', intf='sta49-wlan0', channel=5)
	net.addLink(sta40, cls=mesh, ssid='meshNet', intf='sta40-wlan0', channel=5)
	net.addLink(sta51, cls=mesh, ssid='meshNet', intf='sta51-wlan0', channel=5)
	net.addLink(sta52, cls=mesh, ssid='meshNet', intf='sta52-wlan0', channel=5)
	net.addLink(sta53, cls=mesh, ssid='meshNet', intf='sta53-wlan0', channel=5)
	net.addLink(sta54, cls=mesh, ssid='meshNet', intf='sta54-wlan0', channel=5)
	"""
	net.addLink(sta55, cls=mesh, ssid='meshNet', intf='sta55-wlan0', channel=5)
	net.addLink(sta56, cls=mesh, ssid='meshNet', intf='sta56-wlan0', channel=5)
	net.addLink(sta57, cls=mesh, ssid='meshNet', intf='sta57-wlan0', channel=5)
	net.addLink(sta58, cls=mesh, ssid='meshNet', intf='sta58-wlan0', channel=5)
	net.addLink(sta59, cls=mesh, ssid='meshNet', intf='sta59-wlan0', channel=5)
	net.addLink(sta50, cls=mesh, ssid='meshNet', intf='sta50-wlan0', channel=5)
	#net.addLink(sta61, cls=mesh, ssid='meshNet', intf='sta61-wlan0', channel=5)
	#net.addLink(sta62, cls=mesh, ssid='meshNet', intf='sta62-wlan0', channel=5)
	#net.addLink(sta63, cls=mesh, ssid='meshNet', intf='sta63-wlan0', channel=5)
	#net.addLink(sta64, cls=mesh, ssid='meshNet', intf='sta64-wlan0', channel=5)
	net.addLink(sta65, cls=mesh, ssid='meshNet', intf='sta65-wlan0', channel=5)
	net.addLink(sta66, cls=mesh, ssid='meshNet', intf='sta66-wlan0', channel=5)
	net.addLink(sta67, cls=mesh, ssid='meshNet', intf='sta67-wlan0', channel=5)
	net.addLink(sta68, cls=mesh, ssid='meshNet', intf='sta68-wlan0', channel=5)
	net.addLink(sta69, cls=mesh, ssid='meshNet', intf='sta69-wlan0', channel=5)
	net.addLink(sta60, cls=mesh, ssid='meshNet', intf='sta60-wlan0', channel=5)
	#net.addLink(sta71, cls=mesh, ssid='meshNet', intf='sta71-wlan0', channel=5)
	#net.addLink(sta72, cls=mesh, ssid='meshNet', intf='sta72-wlan0', channel=5)
	#net.addLink(sta73, cls=mesh, ssid='meshNet', intf='sta73-wlan0', channel=5)
	#net.addLink(sta74, cls=mesh, ssid='meshNet', intf='sta74-wlan0', channel=5)
	net.addLink(sta75, cls=mesh, ssid='meshNet', intf='sta75-wlan0', channel=5)
	net.addLink(sta76, cls=mesh, ssid='meshNet', intf='sta76-wlan0', channel=5)
	net.addLink(sta77, cls=mesh, ssid='meshNet', intf='sta77-wlan0', channel=5)
	net.addLink(sta78, cls=mesh, ssid='meshNet', intf='sta78-wlan0', channel=5)
	net.addLink(sta79, cls=mesh, ssid='meshNet', intf='sta79-wlan0', channel=5)
	net.addLink(sta70, cls=mesh, ssid='meshNet', intf='sta70-wlan0', channel=5)
	#net.addLink(sta81, cls=mesh, ssid='meshNet', intf='sta81-wlan0', channel=5)
	#net.addLink(sta82, cls=mesh, ssid='meshNet', intf='sta82-wlan0', channel=5)
	#net.addLink(sta83, cls=mesh, ssid='meshNet', intf='sta83-wlan0', channel=5)
	#net.addLink(sta84, cls=mesh, ssid='meshNet', intf='sta84-wlan0', channel=5)
	net.addLink(sta85, cls=mesh, ssid='meshNet', intf='sta85-wlan0', channel=5)
	net.addLink(sta86, cls=mesh, ssid='meshNet', intf='sta86-wlan0', channel=5)
	net.addLink(sta87, cls=mesh, ssid='meshNet', intf='sta87-wlan0', channel=5)
	net.addLink(sta88, cls=mesh, ssid='meshNet', intf='sta88-wlan0', channel=5)
	net.addLink(sta89, cls=mesh, ssid='meshNet', intf='sta89-wlan0', channel=5)
	net.addLink(sta80, cls=mesh, ssid='meshNet', intf='sta80-wlan0', channel=5)
	#net.addLink(sta91, cls=mesh, ssid='meshNet', intf='sta91-wlan0', channel=5)
	#net.addLink(sta92, cls=mesh, ssid='meshNet', intf='sta92-wlan0', channel=5)
	#net.addLink(sta93, cls=mesh, ssid='meshNet', intf='sta93-wlan0', channel=5)
	#net.addLink(sta94, cls=mesh, ssid='meshNet', intf='sta94-wlan0', channel=5)
	net.addLink(sta95, cls=mesh, ssid='meshNet', intf='sta95-wlan0', channel=5)
	net.addLink(sta96, cls=mesh, ssid='meshNet', intf='sta96-wlan0', channel=5)
	net.addLink(sta97, cls=mesh, ssid='meshNet', intf='sta97-wlan0', channel=5)
	net.addLink(sta98, cls=mesh, ssid='meshNet', intf='sta98-wlan0', channel=5)
	net.addLink(sta99, cls=mesh, ssid='meshNet', intf='sta99-wlan0', channel=5)
	net.addLink(sta90, cls=mesh, ssid='meshNet', intf='sta90-wlan0', channel=5)
	#net.addLink(sta101, cls=mesh, ssid='meshNet', intf='sta101-wlan0', channel=5)
	#net.addLink(sta102, cls=mesh, ssid='meshNet', intf='sta102-wlan0', channel=5)
	#net.addLink(sta103, cls=mesh, ssid='meshNet', intf='sta103-wlan0', channel=5)
	#net.addLink(sta104, cls=mesh, ssid='meshNet', intf='sta104-wlan0', channel=5)
	net.addLink(sta105, cls=mesh, ssid='meshNet', intf='sta105-wlan0', channel=5)
	net.addLink(sta106, cls=mesh, ssid='meshNet', intf='sta106-wlan0', channel=5)
	net.addLink(sta107, cls=mesh, ssid='meshNet', intf='sta107-wlan0', channel=5)
	net.addLink(sta108, cls=mesh, ssid='meshNet', intf='sta108-wlan0', channel=5)
	net.addLink(sta109, cls=mesh, ssid='meshNet', intf='sta109-wlan0', channel=5)
	net.addLink(sta100, cls=mesh, ssid='meshNet', intf='sta100-wlan0', channel=5)

	net.addLink(ap1, cls=mesh, ssid='meshNet', intf='ap1-wlan2', channel=5)

	#net.plotGraph(max_x=300, max_y=300) 

	info("*** Starting network\n")
	net.build()
	net.addNAT().configDefault()
	c1.start()
	ap1.start([c1])

	
	if len(sys.argv) > 1 :
		info("*** Introducing loss ", sys.argv[2], "%\n")
		sta55.cmd("tc qdisc add dev sta55-wlan0 root netem loss " + sys.argv[2] + "%")
		sta56.cmd("tc qdisc add dev sta56-wlan0 root netem loss " + sys.argv[2] + "%")
		sta57.cmd("tc qdisc add dev sta57-wlan0 root netem loss " + sys.argv[2] + "%")
		sta58.cmd("tc qdisc add dev sta58-wlan0 root netem loss " + sys.argv[2] + "%")
		sta59.cmd("tc qdisc add dev sta59-wlan0 root netem loss " + sys.argv[2] + "%")
		sta50.cmd("tc qdisc add dev sta50-wlan0 root netem loss " + sys.argv[2] + "%")
		sta65.cmd("tc qdisc add dev sta65-wlan0 root netem loss " + sys.argv[2] + "%")
		sta66.cmd("tc qdisc add dev sta66-wlan0 root netem loss " + sys.argv[2] + "%")
		sta67.cmd("tc qdisc add dev sta67-wlan0 root netem loss " + sys.argv[2] + "%")
		sta68.cmd("tc qdisc add dev sta68-wlan0 root netem loss " + sys.argv[2] + "%")
		sta69.cmd("tc qdisc add dev sta69-wlan0 root netem loss " + sys.argv[2] + "%")
		sta60.cmd("tc qdisc add dev sta60-wlan0 root netem loss " + sys.argv[2] + "%") 
		sta75.cmd("tc qdisc add dev sta75-wlan0 root netem loss " + sys.argv[2] + "%")
		sta76.cmd("tc qdisc add dev sta76-wlan0 root netem loss " + sys.argv[2] + "%")
		sta77.cmd("tc qdisc add dev sta77-wlan0 root netem loss " + sys.argv[2] + "%")
		sta78.cmd("tc qdisc add dev sta78-wlan0 root netem loss " + sys.argv[2] + "%")
		sta79.cmd("tc qdisc add dev sta79-wlan0 root netem loss " + sys.argv[2] + "%")
		sta70.cmd("tc qdisc add dev sta70-wlan0 root netem loss " + sys.argv[2] + "%") 
		sta85.cmd("tc qdisc add dev sta85-wlan0 root netem loss " + sys.argv[2] + "%")
		sta86.cmd("tc qdisc add dev sta86-wlan0 root netem loss " + sys.argv[2] + "%")
		sta87.cmd("tc qdisc add dev sta87-wlan0 root netem loss " + sys.argv[2] + "%")
		sta88.cmd("tc qdisc add dev sta88-wlan0 root netem loss " + sys.argv[2] + "%")
		sta89.cmd("tc qdisc add dev sta89-wlan0 root netem loss " + sys.argv[2] + "%")
		sta80.cmd("tc qdisc add dev sta80-wlan0 root netem loss " + sys.argv[2] + "%") 
		sta95.cmd("tc qdisc add dev sta95-wlan0 root netem loss " + sys.argv[2] + "%")
		sta96.cmd("tc qdisc add dev sta96-wlan0 root netem loss " + sys.argv[2] + "%")
		sta97.cmd("tc qdisc add dev sta97-wlan0 root netem loss " + sys.argv[2] + "%")
		sta98.cmd("tc qdisc add dev sta98-wlan0 root netem loss " + sys.argv[2] + "%")
		sta99.cmd("tc qdisc add dev sta99-wlan0 root netem loss " + sys.argv[2] + "%")
		sta90.cmd("tc qdisc add dev sta90-wlan0 root netem loss " + sys.argv[2] + "%") 
		sta105.cmd("tc qdisc add dev sta105-wlan0 root netem loss " + sys.argv[2] + "%")
		sta106.cmd("tc qdisc add dev sta106-wlan0 root netem loss " + sys.argv[2] + "%")
		sta107.cmd("tc qdisc add dev sta107-wlan0 root netem loss " + sys.argv[2] + "%")
		sta108.cmd("tc qdisc add dev sta108-wlan0 root netem loss " + sys.argv[2] + "%")
		sta109.cmd("tc qdisc add dev sta109-wlan0 root netem loss " + sys.argv[2] + "%")
		sta100.cmd("tc qdisc add dev sta100-wlan0 root netem loss " + sys.argv[2] + "%")

	f = sys.argv[2] if len(sys.argv) > 1 else "0"
		
	info("*** Running Test\n")
	sta55.cmd("ping -c600 -s1232 198.51.100.100 | tee log/M_W_6_"+f+"L_6x6_Initial.log")

	#sta77.cmd("ping -c 300 -s 1232 198.51.100.100 | tee log/M_W_6_0L_" + f + "x" + f + "_Stable.log")

	#info("*** Running PDR\n")
	#sta11.cmd("for i in `seq 1 10`; do ping -c30 198.51.100.100; done | tee log/M_W_6_" + fileNameVar + "L_6x_PDR.log")

	#info("*** Running Throughput\n")
	#sta11.cmd("script -q -c \"iperf -c 198.51.100.100 -u -n 2M\" > log/M_W_6_" + fileNameVar + "L_6x_udp.log")

	#info("*** Running CLI\n")
	#CLI(net)

	info("*** Stopping network\n")
	net.stop()


if __name__ == '__main__':
    setLogLevel('info')
    topology()
