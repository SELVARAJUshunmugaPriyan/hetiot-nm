#!/usr/bin/python

'This example shows how to create multiple interfaces in stations'

import sys
from mininet.log import setLogLevel, info
from mn_wifi.cli import CLI
from mn_wifi.net import Mininet_wifi
from mn_wifi.link import wmediumd, adhoc
from mn_wifi.wmediumdConnector import interference


def topology():
    "Create a network."
    net = Mininet_wifi(link=wmediumd, wmediumd_mode=interference)

    info("*** Creating nodes\n")
    sta11 = net.addStation('sta11', position='0,0,0')
    sta12 = net.addStation('sta12', position='50,0,0')
    sta13 = net.addStation('sta13', position='100,0,0')
    sta14 = net.addStation('sta14', position='150,0,0')
    sta15 = net.addStation('sta15', position='200,0,0')
    sta16 = net.addStation('sta16', position='250,0,0')
    sta21 = net.addStation('sta21', position='0,50,0')
    sta22 = net.addStation('sta22', position='50,50,0')
    sta23 = net.addStation('sta23', position='100,50,0')
    sta24 = net.addStation('sta24', position='150,50,0')
    sta25 = net.addStation('sta25', position='200,50,0')
    sta26 = net.addStation('sta26', position='250,50,0')
    sta31 = net.addStation('sta31', position='0,100,0')
    sta32 = net.addStation('sta32', position='50,100,0')
    sta33 = net.addStation('sta33', position='100,100,0')
    sta34 = net.addStation('sta34', position='150,100,0')
    sta35 = net.addStation('sta35', position='200,100,0')
    sta36 = net.addStation('sta36', position='250,100,0')
    sta41 = net.addStation('sta41', position='0,150,0')
    sta42 = net.addStation('sta42', position='50,150,0')
    sta43 = net.addStation('sta43', position='100,150,0')
    sta44 = net.addStation('sta44', position='150,150,0')
    sta45 = net.addStation('sta45', position='200,150,0')
    sta46 = net.addStation('sta46', position='250,150,0')
    sta51 = net.addStation('sta51', position='0,200,0')
    sta52 = net.addStation('sta52', position='50,200,0')
    sta53 = net.addStation('sta53', position='100,200,0')
    sta54 = net.addStation('sta54', position='150,200,0')
    sta55 = net.addStation('sta55', position='200,200,0')
    sta56 = net.addStation('sta56', position='250,200,0')
    sta61 = net.addStation('sta61', position='0,250,0')
    sta62 = net.addStation('sta62', position='50,250,0')
    sta63 = net.addStation('sta63', position='100,250,0')
    sta64 = net.addStation('sta64', position='150,250,0')
    sta65 = net.addStation('sta65', position='200,250,0')
    sta66 = net.addStation('sta66', position='250,250,0', wlans=2)
    ap1 = net.addAccessPoint('ap1', ssid='ssid_1', mode='g', channel='5',
                                                     failMode="standalone", position='300,300,0')

    info("*** Configuring Propagation Model\n")
    net.setPropagationModel(model="logDistance", exp=4)

    info("*** Configuring wifi nodes\n")
    net.configureWifiNodes()

    info("*** Associating...\n")
    net.addLink(ap1, sta66)
    
    net.addLink(sta11, cls=adhoc, ssid='adhocNet', intf='sta11-wlan0')
    net.addLink(sta12, cls=adhoc, ssid='adhocNet', intf='sta12-wlan0')
    net.addLink(sta13, cls=adhoc, ssid='adhocNet', intf='sta13-wlan0')
    net.addLink(sta14, cls=adhoc, ssid='adhocNet', intf='sta14-wlan0')
    net.addLink(sta15, cls=adhoc, ssid='adhocNet', intf='sta15-wlan0')
    net.addLink(sta16, cls=adhoc, ssid='adhocNet', intf='sta16-wlan0')
    net.addLink(sta21, cls=adhoc, ssid='adhocNet', intf='sta21-wlan0')
    net.addLink(sta22, cls=adhoc, ssid='adhocNet', intf='sta22-wlan0')
    net.addLink(sta23, cls=adhoc, ssid='adhocNet', intf='sta23-wlan0')
    net.addLink(sta24, cls=adhoc, ssid='adhocNet', intf='sta24-wlan0')
    net.addLink(sta25, cls=adhoc, ssid='adhocNet', intf='sta25-wlan0')
    net.addLink(sta26, cls=adhoc, ssid='adhocNet', intf='sta26-wlan0')
    net.addLink(sta31, cls=adhoc, ssid='adhocNet', intf='sta31-wlan0')
    net.addLink(sta32, cls=adhoc, ssid='adhocNet', intf='sta32-wlan0')
    net.addLink(sta33, cls=adhoc, ssid='adhocNet', intf='sta33-wlan0')
    net.addLink(sta34, cls=adhoc, ssid='adhocNet', intf='sta34-wlan0')
    net.addLink(sta35, cls=adhoc, ssid='adhocNet', intf='sta35-wlan0')
    net.addLink(sta36, cls=adhoc, ssid='adhocNet', intf='sta36-wlan0')
    net.addLink(sta41, cls=adhoc, ssid='adhocNet', intf='sta41-wlan0')
    net.addLink(sta42, cls=adhoc, ssid='adhocNet', intf='sta42-wlan0')
    net.addLink(sta43, cls=adhoc, ssid='adhocNet', intf='sta43-wlan0')
    net.addLink(sta44, cls=adhoc, ssid='adhocNet', intf='sta44-wlan0')
    net.addLink(sta45, cls=adhoc, ssid='adhocNet', intf='sta45-wlan0')
    net.addLink(sta46, cls=adhoc, ssid='adhocNet', intf='sta46-wlan0')
    net.addLink(sta51, cls=adhoc, ssid='adhocNet', intf='sta51-wlan0')
    net.addLink(sta52, cls=adhoc, ssid='adhocNet', intf='sta52-wlan0')
    net.addLink(sta53, cls=adhoc, ssid='adhocNet', intf='sta53-wlan0')
    net.addLink(sta54, cls=adhoc, ssid='adhocNet', intf='sta54-wlan0')
    net.addLink(sta55, cls=adhoc, ssid='adhocNet', intf='sta55-wlan0')
    net.addLink(sta56, cls=adhoc, ssid='adhocNet', intf='sta56-wlan0')
    net.addLink(sta61, cls=adhoc, ssid='adhocNet', intf='sta61-wlan0')
    net.addLink(sta62, cls=adhoc, ssid='adhocNet', intf='sta62-wlan0')
    net.addLink(sta63, cls=adhoc, ssid='adhocNet', intf='sta63-wlan0')
    net.addLink(sta64, cls=adhoc, ssid='adhocNet', intf='sta64-wlan0')
    net.addLink(sta65, cls=adhoc, ssid='adhocNet', intf='sta65-wlan0')
    net.addLink(sta66, cls=adhoc, ssid='adhocNet', intf='sta66-wlan1')

    net.plotGraph(max_x=300, max_y=300)

    info("*** Starting network\n")
    net.build()
    net.addNAT().configDefault()
    ap1.start([])

    info("*** Addressing...\n")
    
    sta11.setIP('192.168.10.11/24', intf="sta11-wlan0")
    sta12.setIP('192.168.10.12/24', intf="sta12-wlan0")
    sta13.setIP('192.168.10.13/24', intf="sta13-wlan0")
    sta14.setIP('192.168.10.14/24', intf="sta14-wlan0")
    sta15.setIP('192.168.10.15/24', intf="sta15-wlan0")
    sta16.setIP('192.168.10.16/24', intf="sta16-wlan0")
    sta21.setIP('192.168.10.21/24', intf="sta21-wlan0")
    sta22.setIP('192.168.10.22/24', intf="sta22-wlan0")
    sta23.setIP('192.168.10.23/24', intf="sta23-wlan0")
    sta24.setIP('192.168.10.24/24', intf="sta24-wlan0")
    sta25.setIP('192.168.10.25/24', intf="sta25-wlan0")
    sta26.setIP('192.168.10.26/24', intf="sta26-wlan0")
    sta31.setIP('192.168.10.31/24', intf="sta31-wlan0")
    sta32.setIP('192.168.10.32/24', intf="sta32-wlan0")
    sta33.setIP('192.168.10.33/24', intf="sta33-wlan0")
    sta34.setIP('192.168.10.34/24', intf="sta34-wlan0")
    sta35.setIP('192.168.10.35/24', intf="sta35-wlan0")
    sta36.setIP('192.168.10.36/24', intf="sta36-wlan0")
    sta41.setIP('192.168.10.41/24', intf="sta41-wlan0")
    sta42.setIP('192.168.10.42/24', intf="sta42-wlan0")
    sta43.setIP('192.168.10.43/24', intf="sta43-wlan0")
    sta44.setIP('192.168.10.44/24', intf="sta44-wlan0")
    sta45.setIP('192.168.10.45/24', intf="sta45-wlan0")
    sta46.setIP('192.168.10.46/24', intf="sta46-wlan0")
    sta51.setIP('192.168.10.51/24', intf="sta51-wlan0")
    sta52.setIP('192.168.10.52/24', intf="sta52-wlan0")
    sta53.setIP('192.168.10.53/24', intf="sta53-wlan0")
    sta54.setIP('192.168.10.54/24', intf="sta54-wlan0")
    sta55.setIP('192.168.10.55/24', intf="sta55-wlan0")
    sta56.setIP('192.168.10.56/24', intf="sta56-wlan0")
    sta61.setIP('192.168.10.61/24', intf="sta61-wlan0")
    sta62.setIP('192.168.10.62/24', intf="sta62-wlan0")
    sta63.setIP('192.168.10.63/24', intf="sta63-wlan0")
    sta64.setIP('192.168.10.64/24', intf="sta64-wlan0")
    sta65.setIP('192.168.10.65/24', intf="sta65-wlan0")
    sta66.setIP('192.168.10.66/24', intf="sta66-wlan1")

    net.plotGraph(max_x=300, max_y=300)
    sta11.cmd("echo 1 > /proc/sys/net/ipv4/ip_forward")
    sta22.cmd("echo 1 > /proc/sys/net/ipv4/ip_forward")
    sta33.cmd("echo 1 > /proc/sys/net/ipv4/ip_forward")
    sta44.cmd("echo 1 > /proc/sys/net/ipv4/ip_forward")
    sta55.cmd("echo 1 > /proc/sys/net/ipv4/ip_forward")
    sta66.cmd("echo 1 > /proc/sys/net/ipv4/ip_forward")
    ap1.cmd("echo 1 > /proc/sys/net/ipv4/ip_forward")
    sta11.cmd("ip r a 198.51.100.100/32 via 192.168.10.22")
    sta22.cmd("ip r a 198.51.100.100/32 via 192.168.10.33")
    sta33.cmd("ip r a 198.51.100.100/32 via 192.168.10.44")
    sta44.cmd("ip r a 198.51.100.100/32 via 192.168.10.55")
    sta55.cmd("ip r a 198.51.100.100/32 via 192.168.10.66")
    sta66.cmd("ip r a 198.51.100.100/32 via 10.0.0.17")

    ap1.cmd("ip r a 192.168.10.33/32 via 10.0.0.16")
    sta66.cmd("ip r a 192.168.10.33/32 via 192.168.10.55")
    sta55.cmd("ip r a 192.168.10.33/32 via 192.168.10.44")
    sta44.cmd("ip r a 192.168.10.33/32 via 192.168.10.33")
    sta33.cmd("ip r a 192.168.10.22/32 via 192.168.10.22")
    
    
    if len(sys.argv) > 1 :
            info("*** Introducing loss ", sys.argv[2], "%\n")
            sta11.cmd("tc qdisc add dev sta11-wlan0 root netem loss " + sys.argv[2] + "%")
            sta12.cmd("tc qdisc add dev sta12-wlan0 root netem loss " + sys.argv[2] + "%")
            sta13.cmd("tc qdisc add dev sta13-wlan0 root netem loss " + sys.argv[2] + "%")
            sta14.cmd("tc qdisc add dev sta14-wlan0 root netem loss " + sys.argv[2] + "%")
            sta15.cmd("tc qdisc add dev sta15-wlan0 root netem loss " + sys.argv[2] + "%")
            sta16.cmd("tc qdisc add dev sta16-wlan0 root netem loss " + sys.argv[2] + "%")
            sta21.cmd("tc qdisc add dev sta21-wlan0 root netem loss " + sys.argv[2] + "%")
            sta22.cmd("tc qdisc add dev sta22-wlan0 root netem loss " + sys.argv[2] + "%")
            sta23.cmd("tc qdisc add dev sta23-wlan0 root netem loss " + sys.argv[2] + "%")
            sta24.cmd("tc qdisc add dev sta24-wlan0 root netem loss " + sys.argv[2] + "%")
            sta25.cmd("tc qdisc add dev sta25-wlan0 root netem loss " + sys.argv[2] + "%")
            sta26.cmd("tc qdisc add dev sta26-wlan0 root netem loss " + sys.argv[2] + "%") 
            sta31.cmd("tc qdisc add dev sta31-wlan0 root netem loss " + sys.argv[2] + "%")
            sta32.cmd("tc qdisc add dev sta32-wlan0 root netem loss " + sys.argv[2] + "%")
            sta33.cmd("tc qdisc add dev sta33-wlan0 root netem loss " + sys.argv[2] + "%")
            sta34.cmd("tc qdisc add dev sta34-wlan0 root netem loss " + sys.argv[2] + "%")
            sta35.cmd("tc qdisc add dev sta35-wlan0 root netem loss " + sys.argv[2] + "%")
            sta36.cmd("tc qdisc add dev sta36-wlan0 root netem loss " + sys.argv[2] + "%") 
            sta41.cmd("tc qdisc add dev sta41-wlan0 root netem loss " + sys.argv[2] + "%")
            sta42.cmd("tc qdisc add dev sta42-wlan0 root netem loss " + sys.argv[2] + "%")
            sta43.cmd("tc qdisc add dev sta43-wlan0 root netem loss " + sys.argv[2] + "%")
            sta44.cmd("tc qdisc add dev sta44-wlan0 root netem loss " + sys.argv[2] + "%")
            sta45.cmd("tc qdisc add dev sta45-wlan0 root netem loss " + sys.argv[2] + "%")
            sta46.cmd("tc qdisc add dev sta46-wlan0 root netem loss " + sys.argv[2] + "%") 
            sta51.cmd("tc qdisc add dev sta51-wlan0 root netem loss " + sys.argv[2] + "%")
            sta52.cmd("tc qdisc add dev sta52-wlan0 root netem loss " + sys.argv[2] + "%")
            sta53.cmd("tc qdisc add dev sta53-wlan0 root netem loss " + sys.argv[2] + "%")
            sta54.cmd("tc qdisc add dev sta54-wlan0 root netem loss " + sys.argv[2] + "%")
            sta55.cmd("tc qdisc add dev sta55-wlan0 root netem loss " + sys.argv[2] + "%")
            sta56.cmd("tc qdisc add dev sta56-wlan0 root netem loss " + sys.argv[2] + "%") 
            sta61.cmd("tc qdisc add dev sta61-wlan0 root netem loss " + sys.argv[2] + "%")
            sta62.cmd("tc qdisc add dev sta62-wlan0 root netem loss " + sys.argv[2] + "%")
            sta63.cmd("tc qdisc add dev sta63-wlan0 root netem loss " + sys.argv[2] + "%")
            sta64.cmd("tc qdisc add dev sta64-wlan0 root netem loss " + sys.argv[2] + "%")
            sta65.cmd("tc qdisc add dev sta65-wlan0 root netem loss " + sys.argv[2] + "%")
            sta66.cmd("tc qdisc add dev sta66-wlan1 root netem loss " + sys.argv[2] + "%")
	
    f = sys.argv[2] if len(sys.argv) > 1 else "0"

    info("*** Running Test\n")
    sta11.cmd("ping -c 600 -s 1232 198.51.100.100 | tee log/A_W_6_" + f + "L_6x6_.log")
    #sta22.cmd("ping -c 300 -s 1232 198.51.100.100 | tee log/A_W_6_0L_" + f + "x" + f + "_Stable.log")

    #info("*** Running CLI\n")
    #CLI(net)

    info("*** Stopping network\n")
    net.stop()


if __name__ == '__main__':
    setLogLevel('info')
    topology()
